import numpy as np
import simpleaudio as sa
import math


class player():
    def __init__(self, sr, a_freq, overtones, keyshift, speed):
        self.sr = sr
        self.ks = keyshift
        self.speed = speed
        self.melodies = []
        self.ot = overtones
        # calculate note frequencies
        self.a_freq = a_freq
        notes = [0]*12
        notes[0] = a_freq/32
        for i in range(1, 12):
            notes[i] = notes[0] * 2 ** (i / 12)
        self.notes = notes

    def perfectfifths(self):
        notes = [0]*12
        notes[0] = self.a_freq/32
        last = 0
        for i in range(1, 12):
            current = int((i*7) % 12)
            notes[current] = notes[last] * (3/2)
            if notes[current] > notes[0]*2:
                notes[current] = notes[current]/2
            last = current
        self.notes = notes

    def changeot(self, overtones):
        self.ot = overtones

    def addmelody(self, notes):
        buffer = []

        for n in notes:
            note = n[0]
            t = n[1]*self.speed
            if note != None:
                t = t-0.01
                note = note-2+self.ks
                frequency = self.notes[note % 12]*2**(note//12+1)
                base = np.arange(0, t, 1/self.sr)
                freq = (self.ot[0]*np.sin(frequency * base * 2 * np.pi))
                for i in range(1, len(self.ot)):
                    freq += (self.ot[i]*np.sin(frequency *
                                               i * base * 2 * np.pi))
                freq += (20*np.sin(frequency * 1.5 * base * 2 * np.pi))
                buffer.append(freq)
                buffer.append(np.zeros(int(self.sr*0.01)))

            else:
                buffer.append(np.zeros(int(self.sr*t)))

        total = np.hstack(buffer)
        self.melodies.append(total)

    def packaudio(self):
        # concatenate notes

        audio = self.melodies.pop(0)

        for i in self.melodies:
            audio += i
        # normalize to 16-bit range
        audio *= 32767 / np.max(np.abs(audio))
        # convert to 16-bit data
        self.audio = audio.astype(np.int16)

    def playaudio(self):
        # start playback
        play_obj = sa.play_buffer(self.audio, 1, 2, self.sr)

        # wait for playback to finish before exiting
        play_obj.wait_done()


def bouree():
    test = player(96000, 440, [76, 73.1, 62.8, 58,
                               57, 53, 58, 43, 44, 36, 38, 34, 34, 32, 29, 28, 27, 25, 20], 2, 1)

    test.perfectfifths()

    melody1 = [[31, 0.5], [31, 0.75], [26, 0.25], [31, 0.5], [26, 0.5], [19, 0.5], [31, 0.75], [29, 0.25], [28, 0.25], [26, 0.25], [24, 0.75], [23, 0.25], [21, 0.25], [
        19, 0.25], [21, 0.5], [19, 0.5], [31, 0.5], [19, 0.25], [21, 0.25], [23, 0.25], [24, 0.25], [26, 0.5], [23, 0.5], [24, 0.5], [26, 0.5], [19, 1], [19, 0.5], [None, 12]]

    melody2 = [[38, 0.5], [35, 0.75], [33, 0.25], [35, 0.5], [33, 0.5], [38, 0.5], [35, 0.75], [33, 0.25], [31, 0.5], [36, 0.5], [
        40, 1], [40, 0.5], [35, 0.5], [35, 0.5], [38, 0.5], [38, 0.5], [33, 0.5], [35, 0.5], [33, 0.5], [38, 0.5], [38, 0.5], [35, 0.5], [35, 0.5], [None, 12]]

    melody3 = [[43, 0.5], [43, 0.75], [42, 0.25], [43, 0.5], [42, 0.5], [43, 0.5], [38, 0.5], [38, 0.5], [40, 0.25], [
        41, 0.25], [43, 1], [45, 1], [38, 0.5], [38, 0.5], [43, 0.5], [43, 0.5], [42, 0.5], [38, 0.5], [40, 0.5], [42, 0.5], [43, 0.5], [38, 0.5], [38, 0.5], [None, 12]]

    melody4 = [[47, 0.25], [48, 0.25], [50, 0.5], [50, 0.5], [50, 0.75], [48, 0.25], [47, 0.5], [43, 0.5], [43, 0.5], [48, 0.25], [50, 0.25], [52, 0.5], [48, 0.5], [48, 0.75], [
        47, 0.125], [48, 0.125], [50, 0.5], [47, 0.5], [47, 0.5], [47, 0.5], [45, 0.5], [43, 0.5], [45, 0.75], [43, 0.125], [45, 0.125], [47, 0.5], [43, 0.5], [43, 0.5], [None, 12]]

    melody12 = [[None, 12], [31, 0.5], [31, 0.75], [26, 0.25], [31, 0.5], [26, 0.5], [19, 0.5], [31, 0.75], [29, 0.25], [28, 0.25], [26, 0.25], [24, 0.75], [23, 0.25], [21, 0.25], [
        19, 0.25], [21, 0.5], [19, 0.5], [31, 0.5], [19, 0.25], [21, 0.25], [23, 0.25], [24, 0.25], [26, 0.5], [23, 0.5], [24, 0.5], [26, 0.5], [19, 1], [19, 0.5]]

    melody22 = [[None, 12], [38, 0.5], [35, 0.75], [33, 0.25], [35, 0.5], [33, 0.5], [38, 0.5], [35, 0.75], [33, 0.25], [31, 0.5], [36, 0.5], [
        40, 1], [40, 0.5], [35, 0.5], [35, 0.5], [38, 0.5], [38, 0.5], [33, 0.5], [35, 0.5], [33, 0.5], [38, 0.5], [38, 0.5], [35, 0.5], [35, 0.5]]

    melody32 = [[None, 12], [43, 0.5], [43, 0.75], [42, 0.25], [43, 0.5], [42, 0.5], [43, 0.5], [38, 0.5], [38, 0.5], [40, 0.25], [
        41, 0.25], [43, 1], [45, 1], [38, 0.5], [38, 0.5], [43, 0.5], [43, 0.5], [42, 0.5], [38, 0.5], [40, 0.5], [42, 0.5], [43, 0.5], [38, 0.5], [38, 0.5]]

    melody42 = [[None, 12], [47, 0.25], [48, 0.25], [50, 0.5], [50, 0.5], [50, 0.75], [48, 0.25], [47, 0.5], [43, 0.5], [43, 0.5], [48, 0.25], [50, 0.25], [52, 0.5], [48, 0.5], [48, 0.75], [
        47, 0.125], [48, 0.125], [50, 0.5], [47, 0.5], [47, 0.5], [47, 0.5], [45, 0.5], [43, 0.5], [45, 0.75], [43, 0.125], [45, 0.125], [47, 0.5], [43, 0.5], [43, 0.5]]

    test.addmelody(melody1)
    test.addmelody(melody2)
    test.addmelody(melody3)
    test.addmelody(melody4)

    test.changeot([0, 70, 75, 40, 30, 25, 20, 10, 10, 5, 5, 5])

    test.addmelody(melody12)
    test.addmelody(melody22)
    test.addmelody(melody32)
    test.addmelody(melody42)

    test.packaudio()
    test.playaudio()


def vivaldi():
    test = player(44100, 440, [76, 73.1, 62.8, 58,
                               57, 53, 58, 43, 44, 36, 38, 34, 34, 32, 29, 28, 27, 25, 20], 2, 2)

    test.perfectfifths()

    bc = [[21, 3], [16, 3], [21, 3], [14, 3], [21, 3], [14, 6]]*2
    viola = [[40, 8.5], [37, 0.5], [45, 12]]*2
    violin2 = [[48, 3], [47, 3], [49, 3], [50, 4], [49, 2], [50, 6]]*2
    violin1 = [[57, 4], [56, 2], [55, 4], [53, 2], [52, 3], [53, 6]]*2
    bassoon = [[21, 0.375], [33, 0.125], [32, 0.375], [33, 0.125], [24, 0.375], [28, 0.125], [26, 0.375], [28, 0.125], [21, 0.375], [24, 0.125], [23, 0.375], [21, 0.125], [16, 0.375], [28, 0.125], [26, 0.375], [28, 0.125], [20, 0.375], [23, 0.125], [
        21, 0.375], [23, 0.125], [16, 0.375], [20, 0.125], [18, 0.375], [16, 0.125], [21, 0.375], [33, 0.125], [32, 0.375], [33, 0.125], [25, 0.375], [28, 0.125], [26, 0.375], [28, 0.125], [21, 0.375], [25, 0.125], [23, 0.375], [21, 0.125], [
        14, 0.375], [26, 0.125], [25, 0.375], [26, 0.125], [17, 0.375], [21, 0.125], [19, 0.375], [21, 0.125], [14, 0.375], [17, 0.125], [16, 0.375], [14, 0.125], [21, 0.375], [33, 0.125], [32, 0.375], [33, 0.125], [25, 0.375], [33, 0.125], [32, 0.375], [33, 0.125], [21, 0.375], [33, 0.125], [32, 0.375], [33, 0.125], [14, 0.375], [26, 0.125], [24, 0.375], [26, 0.125], [21, 0.375], [26, 0.125], [25, 0.375], [26, 0.125], [17, 0.375], [26, 0.125], [25, 0.375], [26, 0.125], [14, 3]]*2

    test.changeot([60, 55, 50, 55, 40, 20, 10, 10, 10, 5, 5, 5])
    test.addmelody(bc)
    test.addmelody(viola)
    test.addmelody(violin2)
    test.addmelody(violin1)

    test.changeot([76, 73.1, 62.8, 58,
                   57, 53, 58, 43, 44, 39, 38, 40, 34, 36, 32, 30, 27, 25, 20])
    test.addmelody(bassoon)

    test.packaudio()
    test.playaudio()


def folia():
    test = player(44100, 440, [76, 73.1, 62.8, 58,
                               57, 53, 58, 43, 44, 39, 38, 40, 34, 36, 32, 30, 27, 25, 20], 9, 1)

    test.perfectfifths()

    bass = [[14, 1.5], [21, 1.5], [14, 1.5], [12, 1.5], [
        17, 1.5], [12, 1.5], [14, 1.5], [21, 1.5]]*2

    alto = [[38, 1.5], [37, 1.5], [38, 1.5], [40, 1.5], [
        41, 1.5], [40, 1.5], [38, 1.5], [37, 1.5]]*2

    tenor = [[33, 1.5], [33, 1.5], [33, 1.5], [36, 1.5], [
        36, 1.5], [36, 1.5], [33, 1.5], [33, 1.5]]*2

    treble = [[41, 0.5], [41, 0.75], [43, 0.25], [40, 0.5], [40, 0.75], [40, 0.25], [41, 0.5], [41, 0.75], [45, 0.25], [43, 0.5], [43, 0.75], [48, 0.12499],[46,0.12498], [45, 0.5], [
        45, 0.75], [46, 0.25], [43, 0.5], [43, 0.75], [43, 0.25], [41, 0.5], [41, 0.75], [43, 0.25], [40, 0.5], [40, 1]]*2

    test.addmelody(bass)
    test.changeot([50, 70, 75, 40, 30, 25, 20, 10, 10, 5, 5, 5])
    test.addmelody(treble)
    test.addmelody(alto)
    test.addmelody(tenor)

    test.packaudio()
    test.playaudio()

def megalovania():
    test = player(44100, 440, [76, 73.1, 62.8, 58,
                               57, 53, 58, 43, 44, 39, 38, 40, 34, 36, 32, 30, 27, 25, 20], 12, 0.5)

    melody=[[26,0.25],[26,0.25],[38,0.25],[None,0.25],[33,0.5],[None,0.25],[32,0.5],[31,0.5],[29,0.5],[26,0.25],[29,0.25],[31,0.25],[24,0.25],[24,0.25],[38,0.25],[None,0.25],[33,0.5],[None,0.25],[32,0.5],[31,0.5],[29,0.5],[26,0.25],[29,0.25],[31,0.25],[23,0.25],[23,0.25],[38,0.25],[None,0.25],[33,0.5],[None,0.25],[32,0.5],[31,0.5],[29,0.5],[26,0.25],[29,0.25],[31,0.25],[22,0.25],[22,0.25],[38,0.25],[None,0.25],[33,0.5],[None,0.25],[32,0.5],[31,0.5],[29,0.5],[26,0.25],[29,0.25],[31,0.25]]*3
    
    bass=[[None,16],[14,4],[12,4],[11,4],[10,4.0007],[14,4],[12,4],[11,4],[10,4.0007],[None,3.99975]]
    
    bass2=[[None,32],[2,4],[0,4],[-1,4],[-2,4.0007],[None,4.00048]]
    
    melodyend=[[26,0.25],[26,0.25],[38,0.25],[None,0.25],[33,0.5],[None,0.25],[32,0.5],[31,0.5],[29,0.5],[26,0.25],[29,0.25],[31,0.25]]
    
    test.addmelody(melody+melodyend)
    test.addmelody(bass)
    test.addmelody(bass2)
    
    
    test.packaudio()
    test.playaudio()
    
def rickroll():
    test = player(44100, 440, [76, 73.1, 62.8, 58,
                               57, 53, 58, 43, 44, 39, 38, 40, 34, 36, 32, 30, 27, 25, 20], 12, 0.5)

    melodyintro=[[41,2],[36,0.5],[41,0.5],[44,0.5],[48,0.5],[43,2],[38,0.5],[43,0.5],[47,0.5],[49,0.5],[
        48,2],[48,2],[48,1],[36,1],[36,1]]
    
    melody=[[36,0.25],[38,0.25],[41,0.25],[38,0.25],[45,0.5],[None,0.25],[
            45,0.5],[None,0.25],[43,1.5],[36,0.25],[38,0.25],[41,0.25],[38,0.25],[43,0.5],[None,0.25],[
                43,0.5],[None,0.25],[41,1.5],[48,0.25],[50,0.25],[53,0.25],[50,0.25],[53,1],[55,0.5],[52,0.75],[
                    50,0.25],[48,1],[48,0.5],[55,1],[53,2],[None,0.5],[22,0.25],[26,0.25],[29,0.25],[34,0.25],[
                        38,0.25],[41,0.25],[46,0.25],[50,0.25],[48,0.25],[43,0.25],[40,0.25],[36,0.25],[48,0.25],[50,0.25],[
                            53,0.25],[50,0.25],[60,1],[52,0.5],[53,0.75],[52,0.25],[50,0.5],[48,0.25],[50,0.25],[
                            53,0.25],[50,0.25],[45,1],[46,0.5],[43,0.75],[41,0.25],[40,1],[40,0.5],[46,1],[45,2]]
    
    melody2intro=[[24,0.5],[29,0.5],[31,0.5],[32,0.5],[32,2],[31,0.5],[38,0.5],[31,0.5],[26,0.5],[26,2],
             [31,2],[43,2],[43,1],[43,1],[43,1]]
    
    melody2=[[36,0.25],[38,0.25],[41,0.25],[38,0.25],[41,0.5],[None,0.25],[
            41,0.5],[None,0.25],[40,1.5],[36,0.25],[38,0.25],[41,0.25],[38,0.25],[40,0.5],[None,0.25],[
                40,0.5],[None,0.25],[41,1.5],[36,0.25],[38,0.25],[41,0.25],[38,0.25],[45,1],[46,0.5],[43,0.75],[
                    41,0.25],[40,1],[40,0.5],[45,1],[45,2],[None,0.5],
            [22,0.25],[26,0.25],[29,0.25],[34,0.25],[
                38,0.25],[41,0.25],[46,0.25],[50,0.25],[48,0.25],[43,0.25],[40,0.25],[36,0.25],[36,0.25],[38,0.25],[
                41,0.25],[38,0.25],[45,1],[49,0.5],[50,0.75],[45,0.25],[41,0.5],[36,0.25],[38,0.25],[
                41,0.25],[38,0.25],[41,1],[43,0.5],[40,0.75],[38,0.25],[36,1],[36,0.5],[43,1],[41,2]]
    
    alto=[[None,1],[14,0.75],[14,0.75],[12,1.5],[5,0.25],[7,0.25],[9,0.25],[10,0.25],[12,0.75],[13,0.75],[14,1.5],[None,1],[24,1],[26,0.5],[22,0.75],[21,0.25],[19,1],[16,0.5],[16,1],[17,2],[24,0.25],[26,0.25],[29,0.25],[26,0.25],[21,0.75],[21,0.75],[19,1.5],[None,3.5],[24,0.25],[26,0.25],[28,0.25],[26,0.25],[22,1.5],[24,1.5],[24,1],[28,1],[29,2],[None,0.00035]]
    
    altointro=[[20,1],[14,1],[17,1],[20,1],[23,1],[20,1],[19,1],[17,1],[16,2],[16,2],[16,1],[16,1],[16,1]]
    bassintro=[[5,3.5],[6,0.5],[7,3],[11,1],[12,2],[24,2],[24,1],[24,1],[24,1]]
    
    bass=[[None,1],[10,0.75],[10,0.75],[12,1.5],
          [None,1],[9,0.75],[9,0.75],[26,1.5],[None,1],[41,1],[43,0.5],[40,0.75],[38,0.25],[36,1],[9,0.5],[1,1],
          [2,2],[12,0.25],[14,0.25],[17,0.25],[14,0.25],[17,0.75],[17,0.75],[16,1.5],[None,3.5],[12,0.25],[14,0.25],
          [17,0.25],[14,0.25],[7,1.5],[12,1.5],[9,1],[13,1],[14,2],[None,0.00045]]
    
    test.addmelody(bassintro+bass*3)
    
    test.changeot([50, 70, 75, 40, 30, 25, 20, 10, 10, 5, 5, 5])
    test.addmelody(melodyintro+melody*3)
    test.addmelody(melody2intro+melody2*3)
    test.addmelody(altointro+alto*3)
    
    test.packaudio()
    test.playaudio()
    
#folia()
#bouree()
#vivaldi()
#megalovania()
rickroll()
